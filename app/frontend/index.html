<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detecci칩n de Huecos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{
        background: linear-gradient(169deg,rgba(42, 123, 155, 1) 0%, rgba(152, 87, 199, 1) 38%, rgba(237, 83, 204, 1) 100%);
        height: 100lvh;
        overflow-y: auto;
        color:#FFF;
    }
    .btn-claro{
        border: 1px solid #FFF;
        color:#FFF;
        background:none;
    }
    .btn-claro:hover{
        border: 1px solid #FFF;
        background-color: rgba(255,255,255,.4);
    }
    .capa { display: none; }
    .capa.active { display: block; }
    .btn{ border-radius: 100px; }
    .video-wrap { position: relative; display:inline-block;margin-top: 20px; }
    #video { width: 100%; border: 2px solid #FFF; border-radius: 10px; transform:scaleX(-1);}
    #overlay { position:absolute; top:0; left:0; }
  </style>
</head>
<body class="p-3">

  <!-- Capa 0: Loading -->
  <div id="capa_0" class="capa active text-center">
    <div class="spinner-border" style="color:#FFF" role="status"></div>
    <p class="mt-2">Cargando...</p>
  </div>

  <!-- Capa 1: Men칰 -->
  <div id="capa_1" class="capa text-center">
    <h1>Control APP</h1>
    <h3>Men칰</h3>
    <button class="btn btn-claro m-2" onclick="capa(100)">Subir Foto</button>
    <button class="btn btn-claro m-2" onclick="capa(200)">Usar C치mara</button>
  </div>

  <!-- Capa 100: Subir foto -->
<div id="capa_100" class="capa text-center">
  <div class="col-12 col-md-4 offset-md-4">
  <h4>Subir imagen</h4>
  <input type="file" id="fileInput" class="form-control mb-3" accept="image/*">
  <button class="btn btn-claro" onclick="procesarImagen()">Upload & Detect</button>
  <button class="btn btn-claro" onclick="capa(1)">Volver</button>
    <div id="resultado_100" class="mt-3">
      <canvas id="canvas_upload" style="max-width:100%; border:0px solid #FFF; border-radius:10px;"></canvas>
    </div>
  </div>
</div>

  <!-- Capa 200: C치mara -->
  <div id="capa_200" class="capa">
    <div class="col-4 offset-md-4">
      <div class="text-center">
        <h4>LIVE CAM RECORDING</h4>
        <button class="btn btn-claro mt-2" onclick="capturar()">Empezar</button>
        <button class="btn btn-claro mt-2" onclick="finCapturar()">Finalizar</button>
        <button class="btn btn-claro mt-2" onclick="finCapturar();capa(1)">Volver</button>
      </div>
      <div class="video-wrap">
        <video id="video" autoplay playsinline></video>
        <canvas id="overlay" style="border:3px solid #FFF"></canvas>
      </div>
      <canvas id="canvas" style="display:none;"></canvas>
    </div>
  </div>

<script>
  function capa(i) {
    document.querySelectorAll('.capa').forEach(c => c.classList.remove('active'))
    document.getElementById('capa_' + i).classList.add('active')
  }
  setTimeout(() => capa(1), 200)

  const video = document.getElementById('video')
  const overlay = document.getElementById('overlay')
  const ctxOverlay = overlay.getContext('2d')
  const canvas = document.getElementById('canvas')

  async function iniciarCamara() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { width: { ideal: 1280 }, height: { ideal: 720 } }
      })
      video.srcObject = stream
      video.onloadedmetadata = () => {
        // Dimensiones en pixeles reales del video
        overlay.width = video.videoWidth
        overlay.height = video.videoHeight

        // Ajustar el canvas al mismo tama침o que el video en pantalla
        overlay.style.width = (video.clientWidth + 8) + "px"
        overlay.style.height = (video.clientHeight + 4) + "px"
      }
    } catch (err) {
      alert("No se pudo acceder a la c치mara: " + err)
    }
  }

  function dataURLtoBlob(dataUrl) {
    const arr = dataUrl.split(',')
    const mime = arr[0].match(/:(.*?);/)[1]
    const bstr = atob(arr[1])
    let n = bstr.length
    const u8arr = new Uint8Array(n)
    while(n--) u8arr[n] = bstr.charCodeAt(n)
    return new Blob([u8arr], { type: mime })
  }

  async function enviarFrame() {
    // capturamos frame en canvas oculto
    canvas.width = video.videoWidth
    canvas.height = video.videoHeight
    canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height)

    // convertimos a JPG con buena calidad (90%)
    canvas.toBlob(async (blob) => {
      const formData = new FormData()
      formData.append("file", blob, "frame.jpg")

      try {
        const res = await fetch("http://localhost:9000/predict", { method:"POST", body: formData })
        const json = await res.json()

        // limpiar overlay
        ctxOverlay.clearRect(0,0,overlay.width, overlay.height)

        if (json.result) {
          json.result.forEach(([x1,y1,x2,y2]) => {
          let px1 = x1 * overlay.width
          let px2 = x2 * overlay.width
          const py1 = y1 * overlay.height
          const py2 = y2 * overlay.height

          // invertir en X (espejo)
          const tmp1 = overlay.width - px2
          const tmp2 = overlay.width - px1
          px1 = tmp1
          px2 = tmp2

          ctxOverlay.strokeStyle = "green"
          ctxOverlay.lineWidth = 2
          ctxOverlay.strokeRect(px1, py1, px2 - px1, py2 - py1)
          })
        }
      } catch (err) {
        console.error(err)
      }
    }, "image/jpeg", 0.99) // 游녣 calidad 90%
  }

  let interval
  function capturar(){ interval = setInterval(enviarFrame, 1000) }
  function finCapturar(){ clearInterval(interval) }

  document.querySelector('button[onclick="capa(200)"]').addEventListener('click', iniciarCamara)

  function procesarImagen() {
    const file = document.getElementById('fileInput').files[0]
    if (!file) {
      alert("No se seleccion칩 ninguna imagen")
      return
    }

    const reader = new FileReader()
    reader.onload = e => {
      const img = new Image()
      img.onload = () => {
        const canvasUpload = document.getElementById("canvas_upload")
        const ctxUpload = canvasUpload.getContext("2d")

        // ajustar canvas al tama침o de la imagen
        canvasUpload.width = img.width
        canvasUpload.height = img.height
        ctxUpload.drawImage(img, 0, 0)

        // mandar al backend
        const formData = new FormData()
        formData.append("file", file)
        fetch("http://localhost:9000/predict", { method:"POST", body: formData })
          .then(r => r.json())
          .then(json => {
            console.log(json)
            if (json.result) {
              json.result.forEach(([x1,y1,x2,y2]) => {
                const px1 = x1 * canvasUpload.width
                const py1 = y1 * canvasUpload.height
                const px2 = x2 * canvasUpload.width
                const py2 = y2 * canvasUpload.height

                ctxUpload.strokeStyle = "red"
                ctxUpload.lineWidth = 2
                ctxUpload.strokeRect(px1, py1, px2 - px1, py2 - py1)
              })
            }
          })
          .catch(err => console.error(err))
      }
      img.src = e.target.result
    }
    reader.readAsDataURL(file)
  }

</script>
</body>
</html>
